<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="laravel-s 499 错误解决"><meta name="keywords" content=""><meta name="author" content="PaulDo,undefined"><meta name="copyright" content="PaulDo"><title>laravel-s 499 错误解决 | Paul's Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.5"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: undefined
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#问题"><span class="toc-number">1.</span> <span class="toc-text">问题:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析现场"><span class="toc-number">2.</span> <span class="toc-text">分析现场:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析问题"><span class="toc-number">3.</span> <span class="toc-text">分析问题:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过压测验证"><span class="toc-number">4.</span> <span class="toc-text">通过压测验证:</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#先将接口-sleep-3-秒-worker-num-调整到-2-重启-swoole-模拟进程资源紧缺时请求等待-复现-499-问题"><span class="toc-number">4.0.1.</span> <span class="toc-text">先将接口 sleep 3 秒, worker_num 调整到 2, 重启 swoole, 模拟进程资源紧缺时请求等待, 复现 499 问题</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#worker-num-调整到-100"><span class="toc-number">4.0.2.</span> <span class="toc-text">worker_num 调整到 100</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">PaulDo</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(img/home-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Paul's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span></div><div id="post-info"><div id="post-title">laravel-s 499 错误解决</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-08-17</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>线上 lumen 服务优化为 swoole 后, 性能得到显著提升, 但伴随而来一些奇怪的问题, 需要排查</p>
</blockquote>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题:"></a>问题:</h4><p>线上服务偶现 499 错误, 且问题期间伴随着少许 redis 或数据库连接超时</p>
<h4 id="分析现场"><a href="#分析现场" class="headerlink" title="分析现场:"></a>分析现场:</h4><ul>
<li>通过 zabbix 观察报错期间, cpu load 和内存使用未发现异常, 且 cpu 使用率和内存使用率偏低</li>
<li>线上日志, 通过全链路 TraceID 分析, 在 499 发生的期间, nginx 有 access 日志, 但业务代码并未发现任何日志</li>
</ul>
<h4 id="分析问题"><a href="#分析问题" class="headerlink" title="分析问题:"></a>分析问题:</h4><p><a href="https://github.com/hhxsv5/laravel-s" target="_blank" rel="noopener">laravel-s</a> 默认设置的默认工作进程数(worker_num)为 cpu 核心数 <em> 2. 从官方文档查询 <a href="https://wiki.swoole.com/wiki/page/275.html" target="_blank" rel="noopener">worker_num 的定义</a>: “业务代码为同步阻塞，需要根据请求响应时间和系统负载来调整; 最大不得超过SWOOLE_CPU_NUM </em> 1000”. 推断是因为流量较高的情况下, 如果出现网络闪断/DB或redis超时, 正在处理的请求会产生积压, 没有足够的 worker 进程处理, 请求就会积压在 nginx, 直到网络调用方”不耐烦”主动断开连接, nginx 出现 499. 此时内存和 cpu 没有充分利用, 造成资源浪费</p>
<h4 id="通过压测验证"><a href="#通过压测验证" class="headerlink" title="通过压测验证:"></a>通过压测验证:</h4><p>测试环境: 4c 8g</p>
<p>测试准备: 将接口 sleep 若干秒时间, 开始压测</p>
<p>压测工具: <a href="https://github.com/wg/wrk" target="_blank" rel="noopener">wrk</a></p>
<h6 id="先将接口-sleep-3-秒-worker-num-调整到-2-重启-swoole-模拟进程资源紧缺时请求等待-复现-499-问题"><a href="#先将接口-sleep-3-秒-worker-num-调整到-2-重启-swoole-模拟进程资源紧缺时请求等待-复现-499-问题" class="headerlink" title="先将接口 sleep 3 秒, worker_num 调整到 2, 重启 swoole, 模拟进程资源紧缺时请求等待, 复现 499 问题"></a>先将接口 sleep 3 秒, worker_num 调整到 2, 重启 swoole, 模拟进程资源紧缺时请求等待, 复现 499 问题</h6><p>使用压测工具10个线程并发, 持续5秒请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> wrk -s post.lua -t 10 -c 10 -d 5s --latency http://service.test/credit/user_credit</span><br><span class="line">Running 5s test @ http://service.test/credit/user_credit</span><br><span class="line">  10 threads and 10 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     0.00us    0.00us   0.00us    -nan%</span><br><span class="line">    Req/Sec     0.00      0.00     0.00    100.00%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    0.00us</span><br><span class="line">     75%    0.00us</span><br><span class="line">     90%    0.00us</span><br><span class="line">     99%    0.00us</span><br><span class="line">  2 requests in 5.01s, 1.70KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 2</span><br><span class="line">Requests/sec:      0.40</span><br><span class="line">Transfer/sec:     346.72B</span><br></pre></td></tr></table></figure>
<p>nginx访问请求日志可以看出, 访问成功的只有2条, 剩下的均为499主动断开连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">112.126.95.181 - - [16/Aug/2018:19:32:10 +0800] &quot;POST /credit/user_credit HTTP/1.1&quot; 3.003 3.003 200 682 &quot;-&quot; &quot;-&quot; -&#123;\x22user_id\x22:450119&#125;</span><br><span class="line">112.126.95.181 - - [16/Aug/2018:19:32:10 +0800] &quot;POST /credit/user_credit HTTP/1.1&quot; 3.004 3.004 200 682 &quot;-&quot; &quot;-&quot; -&#123;\x22user_id\x22:450119&#125;</span><br><span class="line">112.126.95.181 - - [16/Aug/2018:19:32:12 +0800] &quot;POST /credit/user_credit HTTP/1.1&quot; 5.007 - 499 0 &quot;-&quot; &quot;-&quot; -&#123;\x22user_id\x22:450119&#125;</span><br><span class="line">112.126.95.181 - - [16/Aug/2018:19:32:12 +0800] &quot;POST /credit/user_credit HTTP/1.1&quot; 5.008 - 499 0 &quot;-&quot; &quot;-&quot; -&#123;\x22user_id\x22:450119&#125;</span><br><span class="line">112.126.95.181 - - [16/Aug/2018:19:32:12 +0800] &quot;POST /credit/user_credit HTTP/1.1&quot; 5.009 - 499 0 &quot;-&quot; &quot;-&quot; -&#123;\x22user_id\x22:450119&#125;</span><br><span class="line">112.126.95.181 - - [16/Aug/2018:19:32:12 +0800] &quot;POST /credit/user_credit HTTP/1.1&quot; 5.010 - 499 0 &quot;-&quot; &quot;-&quot; -&#123;\x22user_id\x22:450119&#125;</span><br></pre></td></tr></table></figure>
<p>php请求日志中, 接收到4条请求日志:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[2018-08-16 19:32:07.232160] INFO F0C45E8A-541B-EA05-AA8E-A2446761DDAE - - - F0C45E8A-541B-EA05-AA8E-A2446761DDAE - [] - - - ===&gt;/credit/user_credit ip: [112.126.95.181]; params: &#123;&quot;user_id&quot;:450119&#125; &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:07.233247] INFO A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - - - A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - [] - - - ===&gt;/credit/user_credit ip: [112.126.95.181]; params: &#123;&quot;user_id&quot;:450119&#125; &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:10.233018] INFO F0C45E8A-541B-EA05-AA8E-A2446761DDAE - - - F0C45E8A-541B-EA05-AA8E-A2446761DDAE - [] - - - &lt;===/credit/user_credit cost: 3001 ms &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:10.233913] INFO F0C45E8A-541B-EA05-AA8E-A2446761DDAE - - - F0C45E8A-541B-EA05-AA8E-A2446761DDAE - [] - - - ===&gt;/credit/user_credit ip: [112.126.95.181]; params: &#123;&quot;user_id&quot;:450119&#125; &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:10.234961] INFO A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - - - A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - [] - - - &lt;===/credit/user_credit cost: 3002 ms &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:10.235735] INFO A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - - - A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - [] - - - ===&gt;/credit/user_credit ip: [112.126.95.181]; params: &#123;&quot;user_id&quot;:450119&#125; &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:13.236693] INFO F0C45E8A-541B-EA05-AA8E-A2446761DDAE - - - F0C45E8A-541B-EA05-AA8E-A2446761DDAE - [] - - - &lt;===/credit/user_credit cost: 3003 ms &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br><span class="line">[2018-08-16 19:32:13.237531] INFO A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - - - A9EC701C-C2FC-829C-52F3-8B93EB2548F5 - [] - - - &lt;===/credit/user_credit cost: 3002 ms &#123;&quot;qd_type&quot;:&quot;sys&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>调整压测持续时间为1分钟, 观察系统负载, 发现系统毫无压力, 与线上现象匹配</p>
<h6 id="worker-num-调整到-100"><a href="#worker-num-调整到-100" class="headerlink" title="worker_num 调整到 100"></a>worker_num 调整到 100</h6><p>再次压测发现, 并发量已经上来了, 就不放示例了, 大家可以自行测试一下</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>在测试环境进行压测不仅要测试接口正常的性能, 还应该模拟响应耗时比长的场景对服务的影响, 然后想办法最大化利用系统资源提高并发量</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">PaulDo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://pauldo.me/2018/08/17/laravel-s-499-错误解决/">http://pauldo.me/2018/08/17/laravel-s-499-错误解决/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="next-post pull-right"><a href="/2018/06/15/hello-world/"><span>Hello World</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 By PaulDo</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.5"></script><script src="/js/fancybox.js?version=1.5.5"></script><script src="/js/sidebar.js?version=1.5.5"></script><script src="/js/copy.js?version=1.5.5"></script><script src="/js/fireworks.js?version=1.5.5"></script><script src="/js/transition.js?version=1.5.5"></script><script src="/js/scroll.js?version=1.5.5"></script><script src="/js/head.js?version=1.5.5"></script></body></html>